+function(){var e={_ui:{},defendList:[],oDefendHash:{},onlineList:[],init:function(){this.view(),this.bindEvent(),this.listenYpEvent(),this.listenSocketEvent(),this.fLoadDefendList(),this.fLoadCarGuardList()},view:function(){var e=this,n=e._ui;n.$defend_list_panel=$("#js-defend-list-panel"),n.$defend_list_tab=$("#js-defend-list-tab"),n.defend_list_html='<li class="${offLine} ${fourth} js-defend-list-item" data-uid="${uid}">        <a href="javascript:;">          <div class="img-box">            <i class="guardian-icon guardian-${level}"></i>            <img src="${avatar}-medium" alt="">          </div>        </a>        <p class="name">${nickname}</p>      </li>',n.$defend_list_panel.find(".js-defend-list-area").append('<div class="new-tips-ibox" id="js-defend-list-hover-tips" style="display:none;">                          <i class="arrow"></i>                          <p class="tips-name js-defend-nickname"></p>                          <div class="sub-info clearfix">                            <div class="guardian-level">                              <span class="js-defend-level-name"></span>守护                            </div>                            <div class="time">                              剩余<span class="js-defend-endtime"></span>                            </div>                          </div>                        </div>'),n.$defend_list_hover_tips=$("#js-defend-list-hover-tips")},bindEvent:function(){var e=this,n=e._ui;n.$defend_list_tab.on("click",".js-defend-buy-btn",function(e){e.preventDefault(),yp.pub("page/defend/buy")}),n.$defend_list_panel.on("click",".js-defend-buy-btn",function(e){e.preventDefault(),yp.pub("page/defend/buy")}),n.$defend_list_panel.find(".js-defend-list").on("mouseenter",".js-defend-list-item",function(n){e.fShowDefendInfo($(this))}).on("mouseleave",".js-defend-list-item",function(n){e.fHideDefendInfo()})},listenYpEvent:function(){var e=this;yp.sub("page/defend/buy",function(){e.fBuyDefend()}),yp.sub("page/room/change",function(){e.defendList=[],e.oDefendHash={},e.onlineList=[],e.fLoadDefendList()}),yp.sub("page/room/login/done",function(){e.fCheckMyDefendEndTime()}),yp.sub("page/follow/done",function(n,i){if(i.flag){var d;yp.each(e.defendList,function(e,n){return e.uid==oPageConfig.oLoginInfo.uid?(d=e,!1):void 0}),d||yp.pub("page/guide/defend/follow")}else yp.pub("page/guide/defend/unfollow")})},listenSocketEvent:function(){var e=this;e._ui;$.topic("msgc/useronline").sub(function(n){e.onlineList=n.data||[],e.fRanderDefend()}),$.topic("msgc/roomguard").sub(function(n){n.data.totalTime=n.data.endtime-n.data.createtime,n.data.leftTime=n.data.remaintime,n.data.leftTimeShow=e.fLeftTimeShow(n.data.leftTime);var i=!1;if(e.oDefendHash[n.data.uid]=n.data,yp.each(e.defendList,function(d,t){return d.uid==n.data.uid?(e.defendList[t]=n.data,i=!0,!1):void 0}),!i&&e.defendList.push(n.data),e.fRanderDefend(),(!oPageConfig.oLoginInfo||oPageConfig.oLoginInfo.uid!=n.data.uid)&&oPageConfig.aDefendEffect[n.data.level]&&oPageConfig.aDefendEffect[n.data.level].open){var d={};d.data=$.extend({},oPageConfig.aDefendEffect[n.data.level].open,{name:n.data.nickname,slevel:{level:n.data.slevel,pos:n.data.pos},uid:n.data.uid}),yp.pub("page/car/effect/show",d)}}),$.topic("msgc/signmsg").sub(function(e){yp.pub("page/room/sysmsg",{content:e.content})})},fBuyDefend:function(){var e=this;_ui=e._ui,oPageConfig.oLoginInfo?oPageConfig.oLoginInfo.uid!=oPageConfig.oRoom.uid?e.fShowBuyPanel():yp.errorNotify("您无法成为自己的守护"):yp.pub("page/login")},fLoadDefendList:function(){var e=this;e._ui;yp.ajax("/api/static/v2.1/room/guardlist/"+oPageConfig.oRoom.id+"/1000.json",{type:"get",data:{roomId:oPageConfig.oRoom.id,_v:Math.floor($.now()/6e4)},dataType:"json"}).done(function(n){0==n.code&&(yp.each(n.data.guard,function(n){n.leftTime=n.remaintime,0<n.leftTime&&(n.totalTime=n.endtime-n.createtime,n.leftTimeShow=e.fLeftTimeShow(n.leftTime),e.defendList.push(n),e.oDefendHash[n.uid]=n)}),e.fRanderDefend(),e.fCheckMyDefendEndTime())})},fRanderDefend:function(){var e=this,n=e._ui,i="",d=e.defendList.length;d&&fSortArr(e.defendList,{by:function(n){return+(-1!=$.inArray(+n.uid,e.onlineList))},bAsc:!1},{by:"level",bAsc:!1},{by:"guardCost",bAsc:!1}),yp.each(e.defendList,function(d,t){d.offLine=-1!=$.inArray(+d.uid,e.onlineList)?"":"off-line",d.guardName=window.aGuard[d.level],d.fourth=3==t%4?"fourth":"",i+=yp.format(n.defend_list_html,d)}),i+='<li class="add">                  <a href="javascript:;" class="img-box js-defend-buy-btn"></a>                </li>',n.$defend_list_panel.find(".js-defend-list").html(i).toggle(d>0),n.$defend_list_panel.find(".js-no-defend-area").toggle(0==d),n.$defend_list_tab.find(".js-defend-total").html(d>999?"999+":d)},fLeftTimeShow:function(e){var n=Math.ceil(e/86400);return n>999?"3年+":n+"天"},bBuyDefendInit:!1,fShowBuyPanel:function(){var e,n=this;yp.each(n.defendList,function(n,i){return n.uid==oPageConfig.oLoginInfo.uid?(e=n,!1):void 0});var i={nickname:oPageConfig.oRoom.nickname,roomId:oPageConfig.oRoom.id,buyLevel:3};e&&(i.buyLevel=e.level,i.oDefendInfo={level:e.level,endtime:e.endtime,leftTime:e.leftTime}),n.bBuyDefendInit?yp.pub("page/buydefend/show",i):yp.use("buyDefend",function(e,d){n.bBuyDefendInit=!0,d.init();var t=e.module.fPropertyVal("oMainData","oRich");e.module.fPropertyVal("oBuyDefend","myRich",t.myRich),e.pub("page/buydefend/show",i)})},fCheckMyDefendEndTime:function(){var e=this;if(!e.defendList.length||!oPageConfig.oLoginInfo)return!1;var n;yp.each(e.defendList,function(e,i){return e.uid==oPageConfig.oLoginInfo.uid?(n=e,!1):void 0}),n&&604800>n.leftTime&&yp.pub("page/guide/defend/endtime")},fShowDefendInfo:function(e){var n=this,i=n.oDefendHash[e.data("uid")];if(!i)return!1;var d=n._ui,t=e.offset(),f=d.$defend_list_panel.find(".js-defend-list-area").offset(),o=e.index();t.left=t.left-f.left-(129-e.outerWidth())/2,t.top=Math.max(t.top-f.top-47,-48),t.right="auto",0==o%4?t.left=0:3==o%4&&(t.left="auto",t.right=0),d.$defend_list_hover_tips.find(".js-defend-nickname").html(i.nickname),d.$defend_list_hover_tips.find(".js-defend-level-name").html(i.guardName),d.$defend_list_hover_tips.find(".js-defend-endtime").html(i.leftTimeShow),d.$defend_list_hover_tips.show().css(t)},fHideDefendInfo:function(){var e=this,n=e._ui;n.$defend_list_hover_tips.hide()},fLoadCarGuardList:function(){$.getScript(oPageConfig.oUrl.sUrlBase+"j/widget/guardList.js?v="+window.oYpConfig.ver)}};"undefined"!=typeof module?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):window.oDefend=e}();